<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="utf-8">
    <title>3D AR Photo Booth</title>
    <meta name="viewport" content="width=device-width,initial-scale=1,user-scalable=no,maximum-scale=1">
    <script type="module" src="https://ajax.googleapis.com/ajax/libs/model-viewer/3.4.0/model-viewer.min.js"></script>
    <style>
        *{margin:0;padding:0;box-sizing:border-box}
        html,body{width:100%;height:100%;overflow:hidden;background:#000}
        body{touch-action:none;font-family:-apple-system,BlinkMacSystemFont,sans-serif}

        #camera{position:fixed;top:0;left:0;width:100%;height:100%;object-fit:cover;z-index:1}

        /* The 3D Container */
        #characters {
            position: fixed;
            top: 0; left: 0;
            width: 100%; height: 100%;
            z-index: 10;
            --poster-color: transparent;
        }

        #controls{
            position:fixed;bottom:28px;left:0;right:0;z-index:100;
            display:flex;justify-content:center;align-items:center;gap:24px;
            pointer-events:none;
        }
        #controls>*{pointer-events:auto}

        .btn-shutter{
            width:74px;height:74px;border-radius:50%;
            background:rgba(255,255,255,0.25);border:4px solid white;
            cursor:pointer;display:flex;align-items:center;justify-content:center;
        }
        .btn-shutter::after{content:'';width:56px;height:56px;border-radius:50%;background:white}
        .btn-shutter:active::after{background:#ccc}

        .btn-round{
            width:52px;height:52px;border-radius:50%;
            background:rgba(0,0,0,0.5);border:2px solid rgba(255,255,255,0.7);
            color:white;font-size:14px;font-weight:700;cursor:pointer;
            display:flex;align-items:center;justify-content:center;
        }

        #flash{display:none;position:fixed;inset:0;background:white;z-index:999;pointer-events:none}

        #preview-modal{
            display:none;position:fixed;inset:0;background:rgba(0,0,0,0.95);
            z-index:10000;flex-direction:column;align-items:center;justify-content:center;padding:20px;
        }
        #preview-modal img{max-width:90%;max-height:70vh;border-radius:12px;border: 2px solid #444;}
        
        .modal-actions{display:flex;gap:16px;margin-top:20px}
        .btn-save{background:#22c55e; color:white; padding:12px 24px; border-radius:20px; border:none; font-weight:bold;}
        .btn-dismiss{background:#6b7280; color:white; padding:12px 24px; border-radius:20px; border:none;}

        #hint{
            position:fixed;top:20px;left:50%;transform:translateX(-50%);z-index:100;
            background:rgba(0,0,0,0.6);color:white;padding:8px 16px;
            border-radius:20px;font-size:12px;pointer-events:none;
        }
    </style>
</head>
<body>

<div id="hint">Rotate with 1 finger â€¢ Move/Zoom with 2 fingers</div>
<video id="camera" autoplay playsinline muted></video>

<model-viewer 
    id="characters" 
    src="https://cdn.tinyglb.com/models/e5707f21e0a943139f00a758e1e4b9f3.glb" 
    camera-controls 
    disable-tap
    auto-rotate
    shadow-intensity="1"
    exposure="1"
    interaction-prompt="none"
    ar-status="not-presenting">
</model-viewer>

<div id="controls">
    <div class="btn-round" onclick="location.reload()">Reset</div>
    <div class="btn-shutter" onclick="capture()"></div>
    <div class="btn-round" onclick="toggleAutoRotate()">Spin</div>
</div>

<div id="flash"></div>

<div id="preview-modal">
    <img id="preview-img" src="" alt="Photo">
    <div class="modal-actions">
        <button class="btn-save" onclick="savePhoto()">ðŸ’¾ Save Photo</button>
        <button class="btn-dismiss" onclick="closePreview()">âœ• Close</button>
    </div>
</div>

<script>
    const video = document.getElementById('camera');
    const modelViewer = document.getElementById('characters');

    // Start Camera
    async function startCamera(){
        try {
            const stream = await navigator.mediaDevices.getUserMedia({
                video: { facingMode: 'environment', width: { ideal: 1920 }, height: { ideal: 1080 } }
            });
            video.srcObject = stream;
        } catch (err) {
            console.error("Camera error:", err);
            alert("Please allow camera access to use the photo booth.");
        }
    }
    startCamera();

    function toggleAutoRotate() {
        modelViewer.autoRotate = !modelViewer.autoRotate;
    }

    async function capture() {
        const flash = document.getElementById('flash');
        flash.style.display = 'block';

        // 1. Grab the 3D model frame as a blob
        const modelBlob = await modelViewer.toBlob({ idealAspect: true });
        const modelUrl = URL.createObjectURL(modelBlob);
        const modelImg = new Image();
        modelImg.src = modelUrl;

        modelImg.onload = () => {
            const canvas = document.createElement('canvas');
            const ctx = canvas.getContext('2d');

            // Match canvas to video dimensions
            const vWidth = video.videoWidth;
            const vHeight = video.videoHeight;
            canvas.width = vWidth;
            canvas.height = vHeight;

            // 2. Draw Background (Camera)
            ctx.drawImage(video, 0, 0, vWidth, vHeight);

            // 3. Draw Foreground (3D Model)
            // We draw the model directly over the video. 
            // Model-viewer's blob maintains transparency.
            ctx.drawImage(modelImg, 0, 0, vWidth, vHeight);

            // 4. Show Preview
            const dataUrl = canvas.toDataURL('image/jpeg', 0.9);
            document.getElementById('preview-img').src = dataUrl;
            document.getElementById('preview-modal').style.display = 'flex';
            
            flash.style.display = 'none';
            URL.revokeObjectURL(modelUrl);
        };
    }

    function savePhoto() {
        const link = document.createElement('a');
        link.download = `ar-3d-photo-${Date.now()}.jpg`;
        link.href = document.getElementById('preview-img').src;
        link.click();
    }

    function closePreview() {
        document.getElementById('preview-modal').style.display = 'none';
    }

    // Auto-hide hint
    setTimeout(() => { document.getElementById('hint').style.display = 'none'; }, 4000);
</script>

</body>
</html>